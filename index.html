<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nombres relatifs ‚Äî R√©visions interactives</title>
<style>
  :root{
    --bg:#0f172a; --card:#1e293b; --accent:#3b82f6;
    --success:#16a34a; --error:#dc2626; --text:#f1f5f9;
    --choice-bg:#334155; --choice-hover:#475569; --explain:#fde047;
    --radius:12px; --shadow:0 4px 10px rgba(0,0,0,.6);
  }
  body.light{
    --bg:#f9fafb; --card:#ffffff; --text:#111827;
    --choice-bg:#f1f5f9; --choice-hover:#e2e8f0; --explain:#444;
    --shadow:0 4px 10px rgba(0,0,0,.1);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{background:var(--accent);color:#fff;text-align:center;padding:14px 48px;font-size:1.25rem;font-weight:700;position:relative}
  #toggleTheme{position:absolute;right:12px;top:8px;background:#fff;color:#000;border:none;border-radius:999px;font-size:1.05rem;cursor:pointer;padding:6px 10px}

  /* Barre s√©rie / options */
  #topbar{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 12px;flex-wrap:wrap}
  #topbar select,#topbar input,#topbar button{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:var(--card);color:var(--text);box-shadow:var(--shadow)}
  #scoreText{font-weight:700;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.25)}
  #startBtn{background:#10b981;color:#fff}
  #emergencyBtn{background:#ef4444;color:#fff}

  nav{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;padding:12px}
  nav button{padding:8px 14px;border:none;border-radius:var(--radius);cursor:pointer;background:var(--accent);color:#fff;font-size:1rem;box-shadow:var(--shadow)}

  /* Layout + placement calculatrice */
  main{display:flex;max-width:1200px;margin:18px auto;gap:20px;padding:0 12px}
  main.row{flex-direction:row !important}
  main.column{flex-direction:column !important}
  main.calc-first .calculator{order:-1}
  .content{flex:2}
  .calculator{flex:1;background:var(--card);padding:15px;border-radius:var(--radius);box-shadow:var(--shadow);height:fit-content}

  .card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:20px}
  .question{margin-bottom:12px;font-weight:700;font-size:1.1rem}
  .choices button{display:block;width:100%;margin:6px 0;padding:10px;border-radius:var(--radius);border:1px solid #94a3b8;cursor:pointer;background:var(--choice-bg);color:var(--text);font-size:1rem;transition:background .2s}
  .choices button:hover{background:var(--choice-hover)}
  .choices button.correct{background:var(--success)!important;color:#fff}
  .choices button.wrong{background:var(--error)!important;color:#fff}
  .refresh{margin-top:14px;padding:8px 14px;border:none;border-radius:var(--radius);cursor:pointer;background:var(--accent);color:#fff;font-size:1rem;box-shadow:var(--shadow)}
  .explain{margin-top:10px;font-weight:700;color:var(--explain)}

  /* Fractions lisibles */
  .frac{display:inline-grid;grid-template-rows:auto auto;text-align:center;vertical-align:middle}
  .frac .num{border-bottom:2px solid currentColor;padding:0 4px}
  .frac .den{padding:0 4px}

  /* Calculatrice */
  #calcDisplay{width:100%;font-size:1.3rem;padding:10px;margin-bottom:10px;text-align:right;border:1px solid #94a3b8;border-radius:var(--radius);background:var(--bg);color:var(--text)}
  #calcButtons{display:flex;flex-wrap:wrap;gap:6px}
  #calcButtons button{flex:1 0 22%;padding:12px;font-size:1.1rem;border-radius:10px;border:none;cursor:pointer;background:#475569;color:#fff}
  body.light #calcButtons button{background:#e2e8f0;color:#000}

  /* ‚ûú Couleurs sp√©ciales */
  #calcButtons .eqBtn{background:#f59e0b !important;color:#000 !important;} /* jaune */
  body.light #calcButtons .eqBtn{background:#fbbf24 !important;color:#000 !important;}
  #calcButtons .clrBtn{background:#ef4444 !important;color:#fff !important;} /* rouge */
  body.light #calcButtons .clrBtn{background:#ef4444 !important;color:#fff !important;}

  @media (max-width:980px){main:not(.row):not(.column){flex-direction:column}}

  /* Calculs compos√©s */
  .line-item{display:flex;gap:8px;align-items:center;margin:8px 0}
  .line-item input{flex:1;padding:8px;border-radius:8px;border:1px solid #94a3b8;background:var(--bg);color:var(--text)}
  .line-item button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .line-item .expected{font-size:.95rem;margin-left:8px;color:var(--explain)}
  .line-item.error input{border-color:var(--error)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#334155;margin-left:6px;font-size:.85rem}
</style>
</head>
<body>
<header>
  üìò R√©visions ‚Äî Les nombres relatifs
  <button id="toggleTheme" title="Basculer th√®me">üåô</button>
</header>

<!-- Panneau S√©rie / Score / Options -->
<div id="topbar">
  <strong>Difficult√© :</strong>
  <select id="level">
    <option value="1">Facile</option>
    <option value="2" selected>Moyen</option>
    <option value="3">Difficile</option>
  </select>

  <label>Questions :
    <input id="numQuestions" type="number" min="1" max="50" value="10" style="width:80px;text-align:center"/>
  </label>

  <button id="startBtn">‚ñ∂ D√©marrer la s√©rie</button>
  <button id="emergencyBtn" disabled>‚ö† Urgence</button>

  <span id="scoreText">Mode libre</span>

  <!-- Position calculatrice + m√©moire -->
  <label>Position calculatrice :
    <select id="calcPos">
      <option value="droite">Droite</option>
      <option value="gauche">Gauche</option>
      <option value="haut">Haut</option>
      <option value="bas">Bas</option>
    </select>
  </label>
</div>

<nav>
  <button onclick="showSection('comparaison')">Comparer</button>
  <button onclick="showSection('valabs')">Valeur absolue & Oppos√©</button>
  <button onclick="showSection('addition')">Addition</button>
  <button onclick="showSection('soustraction')">Soustraction</button>
  <button onclick="showSection('multiplication')">Multiplication</button>
  <button onclick="showSection('division')">Division</button>
  <button onclick="showSection('composes')">Calculs compos√©s</button>
</nav>

<main id="mainLayout" class="row"><!-- def: √† droite -->
  <div class="content">
    <!-- Comparaison -->
    <section id="comparaison" class="card">
      <h2>Comparer des nombres relatifs</h2>
      <div class="question" id="compQ"></div>
      <div class="choices" id="compChoices"></div>
      <p id="compExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Valeur absolue & Oppos√© -->
    <section id="valabs" class="card" style="display:none;">
      <h2>Valeur absolue et oppos√©</h2>
      <div class="question" id="valQ"></div>
      <div class="choices" id="valChoices"></div>
      <p id="valExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Addition -->
    <section id="addition" class="card" style="display:none;">
      <h2>Addition de relatifs</h2>
      <div class="question" id="addQ"></div>
      <div class="choices" id="addChoices"></div>
      <p id="addExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Soustraction -->
    <section id="soustraction" class="card" style="display:none;">
      <h2>Soustraction de relatifs</h2>
      <div class="question" id="subQ"></div>
      <div class="choices" id="subChoices"></div>
      <p id="subExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Multiplication -->
    <section id="multiplication" class="card" style="display:none;">
      <h2>Multiplication de relatifs</h2>
      <div class="question" id="multQ"></div>
      <div class="choices" id="multChoices"></div>
      <p id="multExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Division -->
    <section id="division" class="card" style="display:none;">
      <h2>Division de relatifs</h2>
      <div class="question" id="divQ"></div>
      <div class="choices" id="divChoices"></div>
      <p id="divExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- NOUVEAU : Calculs compos√©s -->
    <section id="composes" class="card" style="display:none;">
      <h2>Calculs compos√©s <span class="pill">Ligne par ligne</span></h2>
      <div style="margin-bottom:10px">
        M√©thode :
        <select id="compMethod" onchange="generateComposed()">
          <option value="A">A ‚Äî Sommes partielles</option>
          <option value="B">B ‚Äî Regrouper + / ‚àí</option>
          <option value="C">C ‚Äî Paires</option>
        </select>
      </div>
      <div class="question" id="compExpr"></div>
      <div id="compLines"></div>
      <p id="compExplain2" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>
  </div>

  <!-- Calculatrice -->
  <div class="calculator">
    <h2>üßÆ Calculatrice</h2>
    <input type="text" id="calcDisplay" disabled />
    <div id="calcButtons"></div>
  </div>
</main>

<script>
/* ================= Th√®me ================= */
document.getElementById('toggleTheme').onclick=()=>{
  document.body.classList.toggle('light');
  document.getElementById('toggleTheme').textContent=document.body.classList.contains('light')?'‚òÄÔ∏è':'üåô';
};

/* ============== Position calculatrice (m√©moire) ============== */
function applyCalcPlacement(){
  const pos=(localStorage.getItem('calcPos')||document.getElementById('calcPos').value);
  const main=document.getElementById('mainLayout');
  document.getElementById('calcPos').value = pos;
  main.classList.remove('row','column','calc-first');
  if(pos==='droite'){ main.classList.add('row'); }
  if(pos==='gauche'){ main.classList.add('row','calc-first'); }
  if(pos==='haut'){ main.classList.add('column','calc-first'); }
  if(pos==='bas'){ main.classList.add('column'); }
}
document.getElementById('calcPos').addEventListener('change',e=>{
  localStorage.setItem('calcPos', e.target.value);
  applyCalcPlacement();
});
applyCalcPlacement();

/* ============== S√©rie / Score ============== */
let current='comparaison';
let modeSerie=false, serieTotal=0, serieIndex=0, serieScore=0, serieLevel=2;
let currentAnswered=false;

function lockUI(lock){
  document.querySelectorAll('nav button').forEach(b=>b.disabled=lock);
  document.getElementById('level').disabled=lock;
  document.getElementById('numQuestions').disabled=lock;
  document.getElementById('startBtn').disabled=lock;
  document.getElementById('emergencyBtn').disabled=!lock;
  document.getElementById('calcPos').disabled=lock;
  const cm=document.getElementById('compMethod'); if(cm) cm.disabled=lock;
}
function getExplainId(){
  return current==='comparaison'?'compExplain':
         current==='valabs'?'valExplain':
         current==='addition'?'addExplain':
         current==='soustraction'?'subExplain':
         current==='multiplication'?'multExplain':
         current==='division'?'divExplain':'compExplain2';
}
function setRefreshLabel(){
  const btn=document.querySelector(`#${current} .refresh`);
  if(!btn) return;
  if(modeSerie){
    btn.textContent = (serieIndex<serieTotal) ? `Suivant (${serieIndex}/${serieTotal})` : 'Terminer';
    btn.disabled = !currentAnswered;
  }else{
    btn.textContent='Nouvel exercice';
    btn.disabled=false;
  }
}
function updateHUD(){
  const text = modeSerie
    ? `Score : ${serieScore}/${serieTotal} ‚Äî Q ${serieIndex}/${serieTotal}`
    : 'Mode libre';
  document.getElementById('scoreText').textContent=text;
}
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

document.getElementById('startBtn').onclick = startSerie;
function startSerie(){
  if(modeSerie) return;
  const n=clamp(parseInt(document.getElementById('numQuestions').value||'10',10),1,50);
  serieTotal=n; serieIndex=1; serieScore=0;
  modeSerie=true; serieLevel=+document.getElementById('level').value;
  lockUI(true); updateHUD(); generateForCurrent(); setRefreshLabel();
  const exp=document.getElementById(getExplainId());
  exp.textContent=`S√©rie lanc√©e : ${serieTotal} question(s) ‚Äî cat√©gorie et options verrouill√©es jusqu‚Äô√† la fin.`;
}
document.getElementById('emergencyBtn').onclick = cancelSerie;
function cancelSerie(){
  if(!modeSerie) return;
  if(!confirm("Annuler l'exercice en cours et tout r√©initialiser ?")) return;
  modeSerie=false; serieTotal=0; serieIndex=0; serieScore=0;
  lockUI(false); updateHUD(); generateForCurrent(); setRefreshLabel();
  document.getElementById(getExplainId()).textContent="S√©rie annul√©e.";
}

/* ============== Nombres & affichages ============== */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function typePoolByLevel(level){ return level===1?['int']:level===2?['int','dec']:['int','dec','frac']; }
function renderNumberHTML(n){
  if(typeof n==='object' && n.frac){
    return `<span class="frac"><span class="num">${n.num}</span><span class="den">${n.den}</span></span>`;
  }
  return n<0?`(${n})`:`${n}`;
}
function renderNumberText(n){
  if(typeof n==='object' && n.frac){
    const s = `${n.num}/${n.den}`;
    return n.num<0?`(${s})`:`(+${s})`;
  }
  return n<0?`(${n})`:`(+${n})`;
}
function formatNumber(type){
  if(type==='int') return randInt(-20,20);
  if(type==='dec') return Math.round((Math.random()*20-10)*10)/10;
  if(type==='frac'){ let num=randInt(-9,9); if(num===0) num=1; let den=[2,4,5,10][randInt(0,3)]; return {frac:true,num,den}; }
}
function htmlOfArray(arr){ return arr.map(renderNumberHTML).join(' + '); }
function evalNumber(n){ return (typeof n==='object' && n.frac)? n.num/n.den : n; }
function two(x){ const v=+x; const r= Math.round(v*100)/100; return (Object.is(r,-0)?0:r).toFixed(2); }

/* ============== QCM commun ============== */
function makeChoices(container, correct, wrongs, explainId, explanation){
  container.innerHTML=''; document.getElementById(explainId).textContent='';
  currentAnswered=false; setRefreshLabel();
  const answers=[correct,...wrongs].sort(()=>Math.random()-0.5);
  answers.forEach(ans=>{
    const btn=document.createElement('button'); btn.innerHTML=ans;
    btn.onclick=()=>{
      container.querySelectorAll('button').forEach(b=>b.disabled=true);
      if(modeSerie && !currentAnswered && ans===correct){ serieScore++; }
      currentAnswered=true; setRefreshLabel();
      if(ans===correct){ btn.classList.add('correct'); }
      else{ btn.classList.add('wrong'); document.getElementById(explainId).textContent='‚ùå '+explanation; }
      updateHUD();
    };
    container.appendChild(btn);
  });
}

/* ============== Modules QCM (6) ============== */
function activeLevel(){ return modeSerie ? serieLevel : +document.getElementById('level').value; }

function newComparison(){
  const pool=typePoolByLevel(activeLevel()); const t=pool[randInt(0,pool.length-1)];
  let a=formatNumber(t), b=formatNumber(t); while(evalNumber(a)===evalNumber(b)) b=formatNumber(t);
  const correct=evalNumber(a)>evalNumber(b)?renderNumberHTML(a):renderNumberHTML(b);
  document.getElementById('compQ').innerHTML=`Quel est le plus grand entre ${renderNumberHTML(a)} et ${renderNumberHTML(b)} ?`;
  const exp=`On compare ${evalNumber(a)} et ${evalNumber(b)} : ${correct} est le plus grand.`;
  makeChoices(document.getElementById('compChoices'),correct,[renderNumberHTML(a),renderNumberHTML(b)].filter(x=>x!==correct),'compExplain',exp);
}
function newValAbs(){
  const pool=typePoolByLevel(activeLevel()); const t=pool[randInt(0,pool.length-1)];
  const n=formatNumber(t);
  if(Math.random()<0.5){
    document.getElementById('valQ').innerHTML=`Valeur absolue de ${renderNumberHTML(n)} ?`;
    const c=Math.abs(evalNumber(n)).toString();
    const exp=`|${evalNumber(n)}| = ${c}`;
    makeChoices(document.getElementById('valChoices'),c,[ (evalNumber(n)+1).toString(), (evalNumber(n)-1).toString() ],'valExplain',exp);
  }else{
    document.getElementById('valQ').innerHTML=`Oppos√© de ${renderNumberHTML(n)} ?`;
    const c=(-evalNumber(n)).toString();
    const exp=`Oppos√© de ${evalNumber(n)} = ${c}`;
    makeChoices(document.getElementById('valChoices'),c,[ (evalNumber(n)+2).toString(), (evalNumber(n)-2).toString() ],'valExplain',exp);
  }
}
function newAddition(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const n=(lvl===1)?2:(lvl===2?randInt(3,4):randInt(4,5));
  const terms=Array.from({length:n},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  const res=two(terms.map(evalNumber).reduce((a,b)=>a+b,0));
  document.getElementById('addQ').innerHTML=`Calcule : ${htmlOfArray(terms)}`;
  const exp=`On additionne : ${terms.map(evalNumber).join(' + ')} = ${res}`;
  makeChoices(document.getElementById('addChoices'),res,[ (+res+1).toFixed(2),(+res-1).toFixed(2) ],'addExplain',exp);
}
function newSubtraction(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const n=(lvl===1)?2:(lvl===2?randInt(3,4):randInt(4,5));
  const terms=Array.from({length:n},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  let val=evalNumber(terms[0]); for(let i=1;i<terms.length;i++) val-=evalNumber(terms[i]);
  const res=two(val);
  document.getElementById('subQ').innerHTML=`Calcule : ${terms.map(renderNumberHTML).join(' - ')}`;
  const exp=`Soustraire = ajouter l‚Äôoppos√© : ${evalNumber(terms[0])} + (${ -evalNumber(terms[1]) }) ‚Ä¶ ‚Üí ${res}`;
  makeChoices(document.getElementById('subChoices'),res,[ (+res+1).toFixed(2),(+res-1).toFixed(2) ],'subExplain',exp);
}
function newMultiplication(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const n=(lvl===1)?2:randInt(2,3);
  const terms=Array.from({length:n},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  const res=two(terms.map(evalNumber).reduce((a,b)=>a*b,1));
  const negs=terms.filter(t=>evalNumber(t)<0).length;
  document.getElementById('multQ').innerHTML=`Calcule : ${terms.map(renderNumberHTML).join(' √ó ')}`;
  const exp=`R√®gle du signe : ${negs} n√©gatif(s) ‚Üí produit ${negs%2===0?'positif':'n√©gatif'}.`;
  makeChoices(document.getElementById('multChoices'),res,[ (+res+1).toFixed(2),(+res-1).toFixed(2) ],'multExplain',exp);
}
function newDivision(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const a=formatNumber(pool[randInt(0,pool.length-1)]);
  let b=formatNumber(pool[randInt(0,pool.length-1)]); while(evalNumber(b)===0) b=formatNumber('int');
  const q=two(evalNumber(a)/evalNumber(b));
  const samesign=(evalNumber(a)>=0&&evalNumber(b)>=0)||(evalNumber(a)<0&&evalNumber(b)<0);
  document.getElementById('divQ').innerHTML=`Calcule : ${renderNumberHTML(a)} √∑ ${renderNumberHTML(b)}`;
  const exp=`R√®gle du signe : ${samesign?'signes identiques ‚Üí quotient positif':'signes contraires ‚Üí quotient n√©gatif'}.`;
  makeChoices(document.getElementById('divChoices'),q,[ (+q+1).toFixed(2),(+q-1).toFixed(2) ],'divExplain',exp);
}

/* ============== Calculs compos√©s (ligne par ligne) ============== */
let compoState=null;

function generateComposed(){
  const lvl=activeLevel();
  const count = (lvl===1)?randInt(3,4):(lvl===2?randInt(4,5):randInt(5,6));
  const pool = (lvl===1)?['int']:['int','dec'];
  const terms = Array.from({length:count},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  const method = document.getElementById('compMethod').value;

  document.getElementById('compExpr').innerHTML = `Calcule : ${htmlOfArray(terms)}<span class="pill">M√©thode ${method}</span>`;

  let lines=[];
  if(method==='A'){
    let s = evalNumber(terms[0]);
    lines.push({prompt:`S0 = ?`, expected:`S0 = ${renderNumberText(terms[0])}`});
    for(let i=1;i<terms.length;i++){
      const t = evalNumber(terms[i]);
      s = +(Math.round((s + t)*100)/100);
      lines.push({prompt:`S${i} = ?`, expected:`S${i} = S${i-1} + ${renderNumberText(terms[i])} = ${two(s)}`});
    }
  }else if(method==='B'){
    const pos = terms.filter(x=>evalNumber(x)>=0);
    const neg = terms.filter(x=>evalNumber(x)<0);
    const sumP = two(pos.reduce((a,b)=>a+evalNumber(b),0));
    const sumN = two(neg.reduce((a,b)=>a+evalNumber(b),0));
    const res = two(+sumP + +sumN);
    lines.push({prompt:`√âtape 1`, expected:`Positifs : ${pos.length?pos.map(renderNumberText).join(' + '):'0'}`});
    lines.push({prompt:`√âtape 2`, expected:`N√©gatifs : ${neg.length?neg.map(renderNumberText).join(' + '):'0'}`});
    lines.push({prompt:`√âtape 3`, expected:`Sommes : P = ${sumP} ; N = ${sumN}`});
    lines.push({prompt:`√âtape 4`, expected:`R√©sultat : P + N = ${res}`});
  }else{
    const pos = terms.filter(x=>evalNumber(x)>=0);
    const neg = terms.filter(x=>evalNumber(x)<0);
    const pairs = Math.min(pos.length,neg.length);
    let partials=[];
    for(let i=0;i<pairs;i++){
      const r=two(evalNumber(pos[i])+evalNumber(neg[i]));
      lines.push({prompt:`Paire ${i+1}`, expected:`${renderNumberText(pos[i])} + ${renderNumberText(neg[i])} = ${r}`});
      partials.push(+r);
    }
    const rest = terms.slice(pairs*2);
    let total = partials.reduce((a,b)=>a+b,0);
    if(rest.length){
      lines.push({prompt:`Reste`, expected:`Reste : ${rest.map(renderNumberText).join(' + ')}`});
      total += rest.reduce((a,b)=>a+evalNumber(b),0);
    }
    lines.push({prompt:`Somme`, expected:`Somme des r√©sultats = ${two(total)}`});
  }

  compoState={lines:lines.map(l=>({...l,done:false,firstTryOk:null,copyMode:false})), idx:0, hadMistake:false, method};
  renderComposedLines();
  currentAnswered=false; setRefreshLabel(); updateHUD();
}

function renderComposedLines(){
  const wrap=document.getElementById('compLines');
  wrap.innerHTML='';
  compoState.lines.forEach((ln, i)=>{
    const div=document.createElement('div');
    div.className='line-item'+(ln.firstTryOk===false?' error':'');
    const label=document.createElement('span'); label.textContent=`${ln.prompt}`;
    const input=document.createElement('input'); input.placeholder='Recopie ta ligne ici‚Ä¶';
    input.value= ln.done ? ln.expected : '';
    input.disabled = (i>compoState.idx);
    const btn=document.createElement('button'); btn.textContent='Valider';
    const exp=document.createElement('span'); exp.className='expected';

    if(ln.done){ input.disabled=true; btn.disabled=true; exp.textContent='‚úî'; }

    btn.onclick=()=>{
      if(i!==compoState.idx || input.disabled) return;
      const val=input.value.trim();
      if(ln.copyMode){
        if(val===ln.expected){
          ln.done=true; ln.copyMode=false; div.classList.remove('error'); exp.textContent='‚úî';
          compoState.idx++;
          if(compoState.idx>=compoState.lines.length){
            if(modeSerie){
              if(!compoState.hadMistake) serieScore++;
              currentAnswered=true; setRefreshLabel(); updateHUD();
            }else{
              document.getElementById('compExplain2').textContent="Exercice termin√©.";
            }
          }
          renderComposedLines();
        }else{
          div.classList.add('error'); exp.textContent='Recopie EXACTEMENT la ligne attendue.';
        }
        return;
      }

      if(val===ln.expected){
        ln.done=true; ln.firstTryOk = (ln.firstTryOk===null)?true:ln.firstTryOk;
        exp.textContent='‚úî';
        compoState.idx++;
        if(compoState.idx>=compoState.lines.length){
          if(modeSerie){
            if(!compoState.hadMistake) serieScore++;
            currentAnswered=true; setRefreshLabel(); updateHUD();
          }else{
            document.getElementById('compExplain2').textContent="Exercice termin√©.";
          }
        }
        renderComposedLines();
      }else{
        ln.firstTryOk = false; compoState.hadMistake=true;
        div.classList.add('error');
        exp.textContent = `R√©ponse attendue : ${ln.expected}`;
        ln.copyMode = true;
      }
    };

    div.appendChild(label);
    div.appendChild(input);
    div.appendChild(btn);
    div.appendChild(exp);
    wrap.appendChild(div);
  });
}

/* ============== Bouton ‚ÄúNouvel exercice / Suivant‚Äù ============== */
function handleRefresh(){
  if(modeSerie){
    if(!currentAnswered) return;
    if(serieIndex < serieTotal){
      serieIndex++;
      generateForCurrent();
      updateHUD();
    }else{
      finishSerie();
    }
  }else{
    generateForCurrent();
  }
}
function finishSerie(){
  modeSerie=false; lockUI(false); updateHUD(); setRefreshLabel();
  const msg=`‚úÖ S√©rie termin√©e : ${serieScore}/${serieTotal} (${Math.round(100*serieScore/serieTotal)}%)`;
  document.getElementById(getExplainId()).textContent=msg;
}

/* ============== Moteur / Nav ============== */
function generateForCurrent(){
  if(current==='comparaison') newComparison();
  else if(current==='valabs') newValAbs();
  else if(current==='addition') newAddition();
  else if(current==='soustraction') newSubtraction();
  else if(current==='multiplication') newMultiplication();
  else if(current==='division') newDivision();
  else if(current==='composes') generateComposed();
  setRefreshLabel(); updateHUD();
}
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  current=id;
  generateForCurrent();
}

/* ============== Calculatrice (boutons color√©s) ============== */
(function makeCalc(){
  const keys=["7","8","9","/","4","5","6","*","1","2","3","-","0",".","=","+","(",")","C"];
  const box=document.getElementById('calcButtons');
  keys.forEach(k=>{
    const b=document.createElement('button'); 
    b.textContent=k;
    if(k==="=") b.classList.add('eqBtn');   // JAUNE
    if(k==="C") b.classList.add('clrBtn');  // ROUGE
    b.onclick=()=>{
      const d=document.getElementById('calcDisplay');
      if(k==="C") d.value="";
      else if(k==="="){ try{ d.value=eval(d.value); }catch{ d.value="Erreur"; } }
      else d.value+=k;
    };
    box.appendChild(b);
  });
})();

/* ============== D√©marrage ============== */
window.onload=()=>{ 
  applyCalcPlacement();
  showSection('comparaison'); 
};
</script>
</body>
</html>
