<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nombres relatifs ‚Äî R√©visions interactives</title>
<style>
  :root{
    --bg:#0f172a; --card:#1e293b; --accent:#3b82f6;
    --success:#16a34a; --error:#dc2626; --text:#f1f5f9;
    --choice-bg:#334155; --choice-hover:#475569; --explain:#fde047;
    --radius:12px; --shadow:0 4px 10px rgba(0,0,0,.6);
  }
  body.light{
    --bg:#f9fafb; --card:#ffffff; --text:#111827;
    --choice-bg:#f1f5f9; --choice-hover:#e2e8f0; --explain:#444;
    --shadow:0 4px 10px rgba(0,0,0,.1);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{background:var(--accent);color:#fff;text-align:center;padding:14px 48px;font-size:1.25rem;font-weight:700;position:relative}
  #toggleTheme{position:absolute;right:12px;top:8px;background:#fff;color:#000;border:none;border-radius:999px;font-size:1.05rem;cursor:pointer;padding:6px 10px}

  /* Barre s√©rie / options */
  #topbar{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 12px;flex-wrap:wrap}
  #topbar select,#topbar input,#topbar button{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:var(--card);color:var(--text);box-shadow:var(--shadow)}
  #scoreText{font-weight:700;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.25)}
  #startBtn{background:#10b981;color:#fff}
  #emergencyBtn{background:#ef4444;color:#fff}
  #confirmLevel{background:#64748b;color:#fff}

  nav{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;padding:12px}
  nav button{padding:8px 14px;border:none;border-radius:var(--radius);cursor:pointer;background:var(--accent);color:#fff;font-size:1rem;box-shadow:var(--shadow)}

  /* Layout + placement calculatrice */
  main{display:flex;max-width:1200px;margin:18px auto;gap:20px;padding:0 12px}
  main.row{flex-direction:row !important}
  main.column{flex-direction:column !important}
  main.calc-first .calculator{order:-1}
  .content{flex:2}
  .calculator{flex:1;background:var(--card);padding:15px;border-radius:var(--radius);box-shadow:var(--shadow);height:fit-content}

  .card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:20px}
  .question{margin-bottom:12px;font-weight:700;font-size:1.1rem}
  .choices button{display:block;width:100%;margin:6px 0;padding:10px;border-radius:var(--radius);border:1px solid #94a3b8;cursor:pointer;background:var(--choice-bg);color:var(--text);font-size:1rem;transition:background .2s}
  .choices button:hover{background:var(--choice-hover)}
  .choices button.correct{background:var(--success)!important;color:#fff}
  .choices button.wrong{background:var(--error)!important;color:#fff}
  .refresh{margin-top:14px;padding:8px 14px;border:none;border-radius:var(--radius);cursor:pointer;background:var(--accent);color:#fff;font-size:1rem;box-shadow:var(--shadow)}
  .explain{margin-top:10px;font-weight:700;color:var(--explain)}

  /* Fractions lisibles */
  .frac{display:inline-grid;grid-template-rows:auto auto;text-align:center;vertical-align:middle}
  .frac .num{border-bottom:2px solid currentColor;padding:0 4px}
  .frac .den{padding:0 4px}

  /* Calculatrice */
  #calcDisplay{width:100%;font-size:1.3rem;padding:10px;margin-bottom:10px;text-align:right;border:1px solid #94a3b8;border-radius:var(--radius);background:var(--bg);color:var(--text)}
  #calcButtons{display:flex;flex-wrap:wrap;gap:6px}
  #calcButtons button{flex:1 0 22%;padding:12px;font-size:1.1rem;border-radius:10px;border:none;cursor:pointer;background:#475569;color:#fff}
  body.light #calcButtons button{background:#e2e8f0;color:#000}
  /* boutons sp√©ciaux */
  #calcButtons .eqBtn{background:#f59e0b !important;color:#000 !important;}
  body.light #calcButtons .eqBtn{background:#fbbf24 !important;color:#000 !important;}
  #calcButtons .clrBtn{background:#ef4444 !important;color:#fff !important;}

  @media (max-width:980px){main:not(.row):not(.column){flex-direction:column}}

  /* Calculs compos√©s */
  .line-item{display:flex;gap:8px;align-items:center;margin:8px 0}
  .line-item input{flex:1;padding:8px;border-radius:8px;border:1px solid #94a3b8;background:var(--bg);color:var(--text)}
  .line-item button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .line-item .expected{font-size:.95rem;margin-left:8px;color:var(--explain)}
  .line-item.error input{border-color:var(--error)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#334155;margin-left:6px;font-size:.85rem}

  .tokenbar{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  .tokenbar button{padding:6px 10px;border:none;border-radius:999px;background:#475569;color:#fff;cursor:pointer}
  body.light .tokenbar button{background:#e2e8f0;color:#000}
  .tokenbar .danger{background:#ef4444;color:#fff}
  .tokenbar .muted{opacity:.8}

  .numpad{display:grid;grid-template-columns:repeat(4,minmax(52px,1fr));gap:6px;margin:8px 0}
  .numpad button{padding:10px 0;border:none;border-radius:10px;background:#475569;color:#fff;cursor:pointer}
  body.light .numpad button{background:#e2e8f0;color:#000}
  .numpad .danger{background:#ef4444}
  .example{margin-top:14px;padding:12px;border-radius:10px;background:rgba(59,130,246,.12)}

  /* ‚ö†Ô∏è Bouton reset local (panic) */
  .panic{background:#f59e0b;color:#000;border:none;border-radius:10px;padding:8px 14px;box-shadow:var(--shadow);margin:8px 0}
  body.light .panic{background:#fbbf24;color:#000}
  .mini{background:#64748b} /* petit bouton "Effacer" de ligne */
</style>
</head>
<body>
<header>
  üìò R√©visions ‚Äî Les nombres relatifs
  <button id="toggleTheme" title="Basculer th√®me">üåô</button>
</header>

<!-- Panneau S√©rie / Score / Options -->
<div id="topbar">
  <strong>Difficult√© :</strong>
  <select id="level">
    <option value="1">Facile</option>
    <option value="2">Moyen</option>
    <option value="3">Difficile</option>
  </select>
  <button id="confirmLevel" title="Appliquer la difficult√©">OK</button>

  <label>Questions :
    <input id="numQuestions" type="number" min="1" max="50" value="10" style="width:80px;text-align:center"/>
  </label>

  <button id="startBtn">‚ñ∂ D√©marrer la s√©rie</button>
  <button id="emergencyBtn" disabled>‚ö† Urgence</button>

  <span id="scoreText">Mode libre</span>

  <!-- Position calculatrice + m√©moire -->
  <label>Position calculatrice :
    <select id="calcPos">
      <option value="droite">Droite</option>
      <option value="gauche">Gauche</option>
      <option value="haut">Haut</option>
      <option value="bas">Bas</option>
    </select>
  </label>
</div>

<nav>
  <button onclick="showSection('comparaison')">Comparer</button>
  <button onclick="showSection('valabs')">Valeur absolue & Oppos√©</button>
  <button onclick="showSection('addition')">Addition</button>
  <button onclick="showSection('soustraction')">Soustraction</button>
  <button onclick="showSection('multiplication')">Multiplication</button>
  <button onclick="showSection('division')">Division</button>
  <button onclick="showSection('composes')">Calculs compos√©s</button>
</nav>

<main id="mainLayout" class="row">
  <div class="content">
    <!-- Comparaison -->
    <section id="comparaison" class="card">
      <h2>Comparer des nombres relatifs</h2>
      <div class="question" id="compQ"></div>
      <div class="choices" id="compChoices"></div>
      <p id="compExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Valeur absolue & Oppos√© -->
    <section id="valabs" class="card" style="display:none;">
      <h2>Valeur absolue et oppos√©</h2>
      <div class="question" id="valQ"></div>
      <div class="choices" id="valChoices"></div>
      <p id="valExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Addition -->
    <section id="addition" class="card" style="display:none;">
      <h2>Addition de relatifs</h2>
      <div class="question" id="addQ"></div>
      <div class="choices" id="addChoices"></div>
      <p id="addExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Soustraction -->
    <section id="soustraction" class="card" style="display:none;">
      <h2>Soustraction de relatifs</h2>
      <div class="question" id="subQ"></div>
      <div class="choices" id="subChoices"></div>
      <p id="subExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Multiplication -->
    <section id="multiplication" class="card" style="display:none;">
      <h2>Multiplication de relatifs</h2>
      <div class="question" id="multQ"></div>
      <div class="choices" id="multChoices"></div>
      <p id="multExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Division -->
    <section id="division" class="card" style="display:none;">
      <h2>Division de relatifs</h2>
      <div class="question" id="divQ"></div>
      <div class="choices" id="divChoices"></div>
      <p id="divExplain" class="explain"></p>
      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>

    <!-- Calculs compos√©s -->
    <section id="composes" class="card" style="display:none;">
      <h2>Calculs compos√©s <span class="pill">Ligne par ligne</span></h2>
      <div style="margin-bottom:10px">
        M√©thode :
        <select id="compMethod" onchange="generateComposed()">
          <option value="A">A ‚Äî Sommes partielles</option>
          <option value="B">B ‚Äî Regrouper + / ‚àí</option>
          <option value="C">C ‚Äî Paires</option>
        </select>
      </div>

      <div class="question" id="compExpr"></div>

      <!-- Barres d‚Äôaide pour la ligne active -->
      <div id="opBar" class="tokenbar"></div>
      <div id="numPad" class="numpad"></div>

      <!-- Bouton reset local (panic) -->
      <button id="compResetBtn" class="panic" title="Repartir de z√©ro sans changer l'√©nonc√©">‚Ü∫ R√©initialiser l‚Äôexercice</button>

      <div id="compLines"></div>
      <p id="compExplain2" class="explain"></p>
      <div id="compExample" class="example"></div>

      <button class="refresh" onclick="handleRefresh()">Nouvel exercice</button>
    </section>
  </div>

  <!-- Calculatrice -->
  <div class="calculator">
    <h2>üßÆ Calculatrice</h2>
    <input type="text" id="calcDisplay" disabled />
    <div id="calcButtons"></div>
  </div>
</main>

<script>
/* ================= Th√®me ================= */
document.getElementById('toggleTheme').onclick=()=>{
  document.body.classList.toggle('light');
  document.getElementById('toggleTheme').textContent=document.body.classList.contains('light')?'‚òÄÔ∏è':'üåô';
};

/* ============== Position calculatrice (m√©moire) ============== */
function applyCalcPlacement(){
  const pos=(localStorage.getItem('calcPos')||document.getElementById('calcPos').value);
  const main=document.getElementById('mainLayout');
  document.getElementById('calcPos').value = pos;
  main.classList.remove('row','column','calc-first');
  if(pos==='droite'){ main.classList.add('row'); }
  if(pos==='gauche'){ main.classList.add('row','calc-first'); }
  if(pos==='haut'){ main.classList.add('column','calc-first'); }
  if(pos==='bas'){ main.classList.add('column'); }
}
document.getElementById('calcPos').addEventListener('change',e=>{
  localStorage.setItem('calcPos', e.target.value);
  applyCalcPlacement();
});
applyCalcPlacement();

/* ============== Difficult√© globale (persistante) ============== */
const levelLabels={1:'Facile',2:'Moyen',3:'Difficile'};
let globalLevel = +localStorage.getItem('level') || 2;
document.getElementById('level').value = String(globalLevel);

document.getElementById('confirmLevel').onclick = ()=>{
  globalLevel = +document.getElementById('level').value;
  localStorage.setItem('level', String(globalLevel));
  currentAnswered=false;
  generateForCurrent(); // relance un exercice dans la section courante
  setRefreshLabel(); updateHUD();
  const expId=getExplainId();
  const p=document.getElementById(expId);
  if(p){ p.textContent=`Difficult√© appliqu√©e : ${levelLabels[globalLevel]}.`; }
};

/* ============== S√©rie / Score ============== */
let current='comparaison';
let modeSerie=false, serieTotal=0, serieIndex=0, serieScore=0;
let currentAnswered=false;

function lockUI(lock){
  // difficult√© toujours active
  document.querySelectorAll('nav button').forEach(b=>b.disabled=lock);
  document.getElementById('numQuestions').disabled=lock;
  document.getElementById('startBtn').disabled=lock;
  document.getElementById('emergencyBtn').disabled=!lock;
  document.getElementById('calcPos').disabled=lock;
  const cm=document.getElementById('compMethod'); if(cm) cm.disabled=lock;
}
function getExplainId(){
  return current==='comparaison'?'compExplain':
         current==='valabs'?'valExplain':
         current==='addition'?'addExplain':
         current==='soustraction'?'subExplain':
         current==='multiplication'?'multExplain':
         current==='division'?'divExplain':'compExplain2';
}
function setRefreshLabel(){
  const btn=document.querySelector(`#${current} .refresh`);
  if(!btn) return;
  if(modeSerie){
    btn.textContent = (serieIndex<serieTotal) ? `Suivant (${serieIndex}/${serieTotal})` : 'Terminer';
    btn.disabled = !currentAnswered;
  }else{
    btn.textContent='Nouvel exercice';
    btn.disabled=false;
  }
}
function updateHUD(){
  const text = modeSerie
    ? `Score : ${serieScore}/${serieTotal} ‚Äî Q ${serieIndex}/${serieTotal}`
    : 'Mode libre';
  document.getElementById('scoreText').textContent=text;
}
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

document.getElementById('startBtn').onclick = startSerie;
function startSerie(){
  if(modeSerie) return;
  const n=clamp(parseInt(document.getElementById('numQuestions').value||'10',10),1,50);
  serieTotal=n; serieIndex=1; serieScore=0;
  modeSerie=true;
  lockUI(true); updateHUD(); generateForCurrent(); setRefreshLabel();
  const exp=document.getElementById(getExplainId());
  exp.textContent=`S√©rie lanc√©e (${serieTotal} question(s)) ‚Äî cat√©gorie et options verrouill√©es (sauf difficult√©).`;
}
document.getElementById('emergencyBtn').onclick = cancelSerie;
function cancelSerie(){
  if(!modeSerie) return;
  if(!confirm("Annuler l'exercice en cours et tout r√©initialiser ?")) return;
  modeSerie=false; serieTotal=0; serieIndex=0; serieScore=0;
  // reset compos√©s aussi
  compoState=null;
  document.getElementById('compLines').innerHTML='';
  document.getElementById('opBar').innerHTML='';
  document.getElementById('numPad').innerHTML='';
  document.getElementById('compExplain2').textContent='';
  lockUI(false); updateHUD(); generateForCurrent(); setRefreshLabel();
  document.getElementById(getExplainId()).textContent="S√©rie annul√©e.";
}

/* ============== Nombres & affichages ============== */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function typePoolByLevel(level){ return level===1?['int']:level===2?['int','dec']:['int','dec','frac']; }
function renderNumberHTML(n){
  if(typeof n==='object' && n.frac){
    return `<span class="frac"><span class="num">${n.num}</span><span class="den">${n.den}</span></span>`;
  }
  return n<0?`(${n})`:`${n}`;
}
function renderNumberText(n){
  if(typeof n==='object' && n.frac){ const s = `${n.num}/${n.den}`; return n.num<0?`(${s})`:`(+${s})`; }
  return n<0?`(${n})`:`(+${n})`;
}
function formatNumber(type){
  if(type==='int') return randInt(-20,20);
  if(type==='dec') return Math.round((Math.random()*20-10)*10)/10;
  if(type==='frac'){ let num=randInt(-9,9); if(num===0) num=1; let den=[2,4,5,10][randInt(0,3)]; return {frac:true,num,den}; }
}
function htmlOfArray(arr){ return arr.map(renderNumberHTML).join(' + '); }
function evalNumber(n){ return (typeof n==='object' && n.frac)? n.num/n.den : n; }
function two(x){ const v=+x; const r= Math.round(v*100)/100; return (Object.is(r,-0)?0:r).toFixed(2); }
function signedNice(x){ let s=two(x); if(s.endsWith('.00')) s=s.slice(0,-3); if(s.endsWith('0')&&s.includes('.')) s=s.replace(/\.?0$/,''); if(+s>0&&!s.startsWith('+')) s='+'+s; if(s==='+0') s='+0'; if(s==='-0') s='0'; return s; }
function norm(str){ return str.trim().replace(/\s+/g,' '); }

/* ============== QCM commun ============== */
function makeChoices(container, correct, wrongs, explainId, explanation){
  container.innerHTML=''; document.getElementById(explainId).textContent='';
  currentAnswered=false; setRefreshLabel();
  const answers=[correct,...wrongs].sort(()=>Math.random()-0.5);
  answers.forEach(ans=>{
    const btn=document.createElement('button'); btn.innerHTML=ans;
    btn.onclick=()=>{
      container.querySelectorAll('button').forEach(b=>b.disabled=true);
      if(modeSerie && !currentAnswered && ans===correct){ serieScore++; }
      currentAnswered=true; setRefreshLabel();
      if(ans===correct){ btn.classList.add('correct'); }
      else{ btn.classList.add('wrong'); document.getElementById(explainId).textContent='‚ùå '+explanation; }
      updateHUD();
    };
    container.appendChild(btn);
  });
}

/* ============== Modules QCM (6) ============== */
function activeLevel(){ return globalLevel; }

function newComparison(){
  const pool=typePoolByLevel(activeLevel()); const t=pool[randInt(0,pool.length-1)];
  let a=formatNumber(t), b=formatNumber(t); while(evalNumber(a)===evalNumber(b)) b=formatNumber(t);
  const correct=evalNumber(a)>evalNumber(b)?renderNumberHTML(a):renderNumberHTML(b);
  document.getElementById('compQ').innerHTML=`Quel est le plus grand entre ${renderNumberHTML(a)} et ${renderNumberHTML(b)} ?`;
  const exp=`On compare ${evalNumber(a)} et ${evalNumber(b)} : ${correct} est le plus grand.`;
  makeChoices(document.getElementById('compChoices'),correct,[renderNumberHTML(a),renderNumberHTML(b)].filter(x=>x!==correct),'compExplain',exp);
}
function newValAbs(){
  const pool=typePoolByLevel(activeLevel()); const t=pool[randInt(0,pool.length-1)];
  const n=formatNumber(t);
  if(Math.random()<0.5){
    document.getElementById('valQ').innerHTML=`Valeur absolue de ${renderNumberHTML(n)} ?`;
    const c=Math.abs(evalNumber(n)).toString();
    const exp=`|${evalNumber(n)}| = ${c}`;
    makeChoices(document.getElementById('valChoices'),c,[ (evalNumber(n)+1).toString(), (evalNumber(n)-1).toString() ],'valExplain',exp);
  }else{
    document.getElementById('valQ').innerHTML=`Oppos√© de ${renderNumberHTML(n)} ?`;
    const c=(-evalNumber(n)).toString();
    const exp=`Oppos√© de ${evalNumber(n)} = ${c}`;
    makeChoices(document.getElementById('valChoices'),c,[ (evalNumber(n)+2).toString(), (evalNumber(n)-2).toString() ],'valExplain',exp);
  }
}
function newAddition(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const n=(lvl===1)?2:(lvl===2?randInt(3,4):randInt(4,5));
  const terms=Array.from({length:n},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  const res=two(terms.map(evalNumber).reduce((a,b)=>a+b,0));
  document.getElementById('addQ').innerHTML=`Calcule : ${htmlOfArray(terms)}`;
  const exp=`On additionne : ${terms.map(evalNumber).join(' + ')} = ${res}`;
  makeChoices(document.getElementById('addChoices'),res,[ (+res+1).toFixed(2),(+res-1).toFixed(2) ],'addExplain',exp);
}
function newSubtraction(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const n=(lvl===1)?2:(lvl===2?randInt(3,4):randInt(4,5));
  const terms=Array.from({length:n},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  let val=evalNumber(terms[0]); for(let i=1;i<terms.length;i++) val-=evalNumber(terms[i]);
  const res=two(val);
  document.getElementById('subQ').innerHTML=`Calcule : ${terms.map(renderNumberHTML).join(' - ')}`;
  const exp=`Soustraire = ajouter l‚Äôoppos√© : ${evalNumber(terms[0])} + (${ -evalNumber(terms[1]) }) ‚Ä¶ ‚Üí ${res}`;
  makeChoices(document.getElementById('subChoices'),res,[ (+res+1).toFixed(2),(+res-1).toFixed(2) ],'subExplain',exp);
}
function newMultiplication(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const n=(lvl===1)?2:randInt(2,3);
  const terms=Array.from({length:n},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  const res=two(terms.map(evalNumber).reduce((a,b)=>a*b,1));
  const negs=terms.filter(t=>evalNumber(t)<0).length;
  document.getElementById('multQ').innerHTML=`Calcule : ${terms.map(renderNumberHTML).join(' √ó ')}`;
  const exp=`R√®gle du signe : ${negs} n√©gatif(s) ‚Üí produit ${negs%2===0?'positif':'n√©gatif'}.`;
  makeChoices(document.getElementById('multChoices'),res,[ (+res+1).toFixed(2),(+res-1).toFixed(2) ],'multExplain',exp);
}
function newDivision(){
  const lvl=activeLevel(), pool=typePoolByLevel(lvl);
  const a=formatNumber(pool[randInt(0,pool.length-1)]);
  let b=formatNumber(pool[randInt(0,pool.length-1)]); while(evalNumber(b)===0) b=formatNumber('int');
  const q=two(evalNumber(a)/evalNumber(b));
  const samesign=(evalNumber(a)>=0&&evalNumber(b)>=0)||(evalNumber(a)<0&&evalNumber(b)<0);
  document.getElementById('divQ').innerHTML=`Calcule : ${renderNumberHTML(a)} √∑ ${renderNumberHTML(b)}`;
  const exp=`R√®gle du signe : ${samesign?'signes identiques ‚Üí quotient positif':'signes contraires ‚Üí quotient n√©gatif'}.`;
  makeChoices(document.getElementById('divChoices'),q,[ (+q+1).toFixed(2),(+q-1).toFixed(2) ],'divExplain',exp);
}

/* ============== Calculs compos√©s (ligne par ligne) ============== */
let compoState=null; // {terms, lines:[{prompt,expectedRHS,done,...}], idx, hadMistake, method}

function composedExampleHTML(method){
  if(method==='A'){
    return `
      <strong>Exemple ‚Äî M√©thode A (Sommes partielles)</strong><br/>
      √ânonc√© : (+12) + (-8) + (+6) + (-9)<br/>
      S0 = (+12)<br/>
      S1 = (+12) + (-8) = +4<br/>
      S2 = +4 + (+6) = +10<br/>
      S3 = +10 + (-9) = +1
    `;
  }
  if(method==='B'){
    return `
      <strong>Exemple ‚Äî M√©thode B (Regrouper + / ‚àí)</strong><br/>
      √ânonc√© : (+12) + (-8) + (+6) + (-9)<br/>
      (+12) + (+6) = +18<br/>
      (-8) + (-9) = -17<br/>
      (+18) + (-17) = +1
    `;
  }
  return `
    <strong>Exemple ‚Äî M√©thode C (Paires)</strong><br/>
    √ânonc√© : (+12) + (-8) + (+6) + (-9)<br/>
    (+12) + (-9) = +3<br/>
    (+6) + (-8) = -2<br/>
    +3 + (-2) = +1
  `;
}

function generateComposed(){
  const lvl=activeLevel();
  const count = (lvl===1)?randInt(3,4):(lvl===2?randInt(4,5):randInt(5,6));
  const pool = (lvl===1)?['int']:['int','dec']; // pour saisie simple
  const terms = Array.from({length:count},()=>formatNumber(pool[randInt(0,pool.length-1)]));
  const method = document.getElementById('compMethod').value;

  document.getElementById('compExpr').innerHTML = `Calcule : ${htmlOfArray(terms)}<span class="pill">M√©thode ${method}</span>`;
  document.getElementById('compExample').innerHTML = composedExampleHTML(method);

  // Lignes attendues (RHS uniquement)
  let lines=[];
  if(method==='A'){
    lines.push({prompt:`S0 = ?`, expectedRHS:`${renderNumberText(terms[0])}`});
    let sum = evalNumber(terms[0]);
    for(let i=1;i<terms.length;i++){
      const prev = signedNice(sum);
      sum = +(Math.round((sum + evalNumber(terms[i]))*100)/100);
      const rhs = `${prev} + ${renderNumberText(terms[i])} = ${signedNice(sum)}`;
      lines.push({prompt:`S${i} = ?`, expectedRHS:rhs});
    }
  }else if(method==='B'){
    const pos = terms.filter(x=>evalNumber(x)>=0);
    const neg = terms.filter(x=>evalNumber(x)<0);
    const sumP = signedNice(pos.reduce((a,b)=>a+evalNumber(b),0));
    const sumN = signedNice(neg.reduce((a,b)=>a+evalNumber(b),0));
    const res = signedNice(+sumP + +sumN);
    if(pos.length) lines.push({prompt:`√âtape 1`, expectedRHS:`${pos.map(renderNumberText).join(' + ')} = ${sumP}`});
    if(neg.length) lines.push({prompt:`√âtape 2`, expectedRHS:`${neg.map(renderNumberText).join(' + ')} = ${sumN}`});
    lines.push({prompt:`√âtape 3`, expectedRHS:`(${sumP}) + (${sumN}) = ${res}`});
  }else{
    const pos = terms.filter(x=>evalNumber(x)>=0);
    const neg = terms.filter(x=>evalNumber(x)<0);
    const pairs = Math.min(pos.length,neg.length);
    let partials=[];
    for(let i=0;i<pairs;i++){
      const r = signedNice(evalNumber(pos[i])+evalNumber(neg[i]));
      lines.push({prompt:`Paire ${i+1}`, expectedRHS:`${renderNumberText(pos[i])} + ${renderNumberText(neg[i])} = ${r}`});
      partials.push(+r);
    }
    const rest = terms.slice(pairs*2);
    if(rest.length){
      const sumRest = signedNice(rest.reduce((a,b)=>a+evalNumber(b),0));
      lines.push({prompt:`Reste`, expectedRHS:`${rest.map(renderNumberText).join(' + ')} = ${sumRest}`});
      partials.push(+sumRest);
    }
    if(partials.length>=2){
      const res = signedNice(partials.reduce((a,b)=>a+b,0));
      lines.push({prompt:`Somme`, expectedRHS:`${partials.map(signedNice).join(' + ')} = ${res}`});
    }
  }

  compoState={
    terms,
    lines:lines.map(l=>({...l,done:false,firstTryOk:null,copyMode:false})),
    idx:0, hadMistake:false, method
  };

  renderComposedLines();
  currentAnswered=false; setRefreshLabel(); updateHUD();
}

/* Reset local (panic) ‚Äî garde le m√™me √©nonc√©/m√©thode */
function resetComposedForm(){
  if(!compoState) return;
  compoState.lines.forEach(l=>{
    l.done=false; l.firstTryOk=null; l.copyMode=false;
  });
  compoState.idx=0; compoState.hadMistake=false;
  document.getElementById('compExplain2').textContent='';
  renderComposedLines();
  currentAnswered=false; setRefreshLabel(); updateHUD();
}
document.getElementById('compResetBtn').onclick=resetComposedForm;

/* Barres aide : op√©rateurs et pav√© num√©rique */
function insertOp(input, op){
  let v=input.value;
  const last=v.slice(-1);
  if(op==='(' || op===')'){
    input.value = v + op;
  }else if(op==='+' || op==='-' || op==='='){
    if(v && last!==' ') v+=' ';
    input.value = v + op + ' ';
  }
  input.focus();
}
function insertNum(input, ch){
  input.value = input.value + ch;
  input.focus();
}
function buildOpBar(input){
  const ops=['(',')','+','-','='];
  const bar=document.getElementById('opBar');
  bar.innerHTML='';
  ops.forEach(o=>{
    const b=document.createElement('button'); b.textContent=o;
    b.onclick=()=>insertOp(input,o);
    bar.appendChild(b);
  });
  const back=document.createElement('button'); back.textContent='‚å´'; back.className='muted';
  back.onclick=()=>{ input.value=input.value.slice(0,-1); input.focus(); };
  const clr=document.createElement('button'); clr.textContent='Effacer'; clr.className='danger';
  clr.onclick=()=>{ input.value=''; input.focus(); };
  bar.appendChild(back); bar.appendChild(clr);
}
function buildNumPad(input){
  const pad=document.getElementById('numPad');
  pad.innerHTML='';
  const keys=['7','8','9','4','5','6','1','2','3','0','.'];
  keys.forEach(k=>{
    const b=document.createElement('button'); b.textContent=k;
    b.onclick=()=>insertNum(input,k);
    pad.appendChild(b);
  });
  const sp=document.createElement('button'); sp.textContent='‚ê£'; sp.className='muted';
  sp.onclick=()=>{ if(input.value && !input.value.endsWith(' ')) input.value+=' '; input.focus(); };
  pad.appendChild(sp);
  const clr=document.createElement('button'); clr.textContent='Effacer'; clr.className='danger';
  clr.onclick=()=>{ input.value=''; input.focus(); };
  pad.appendChild(clr);
}

/* Rendu des lignes compos√©s */
function renderComposedLines(){
  const wrap=document.getElementById('compLines');
  wrap.innerHTML='';
  document.getElementById('opBar').innerHTML='';
  document.getElementById('numPad').innerHTML='';

  compoState.lines.forEach((ln, i)=>{
    const div=document.createElement('div');
    div.className='line-item'+(ln.firstTryOk===false?' error':'');
    const label=document.createElement('span'); label.textContent=`${ln.prompt}`;
    const input=document.createElement('input'); input.placeholder='Compose la partie droite, ex : (+12) + (-8) = +4';
    input.value= ln.done ? ln.expectedRHS : '';
    input.disabled = (i>compoState.idx);
    const btn=document.createElement('button'); btn.textContent='Valider';
    const clr=document.createElement('button'); clr.textContent='Effacer'; clr.className='mini';
    const exp=document.createElement('span'); exp.className='expected';

    if(i===compoState.idx && !ln.done){
      buildOpBar(input);
      buildNumPad(input);
      clr.onclick=()=>{ input.value=''; input.focus(); };
      clr.disabled=false;
    }else{
      clr.disabled=true;
    }

    if(ln.done){ input.disabled=true; btn.disabled=true; clr.disabled=true; exp.textContent='‚úî'; }

    btn.onclick=()=>{
      if(i!==compoState.idx || input.disabled) return;
      const val=norm(input.value);
      const expected=norm(ln.expectedRHS);

      if(ln.copyMode){
        if(val===expected){
          ln.done=true; ln.copyMode=false; div.classList.remove('error'); exp.textContent='‚úî';
          compoState.idx++;
          document.getElementById('opBar').innerHTML='';
          document.getElementById('numPad').innerHTML='';
          if(compoState.idx>=compoState.lines.length){
            if(modeSerie){
              if(!compoState.hadMistake) serieScore++;
              currentAnswered=true; setRefreshLabel(); updateHUD();
            }else{
              document.getElementById('compExplain2').textContent="Exercice termin√©.";
            }
          }
          renderComposedLines();
        }else{
          div.classList.add('error'); exp.textContent='Recopie EXACTEMENT la ligne attendue.';
        }
        return;
      }

      if(val===expected){
        ln.done=true; ln.firstTryOk = (ln.firstTryOk===null)?true:ln.firstTryOk;
        exp.textContent='‚úî';
        compoState.idx++;
        document.getElementById('opBar').innerHTML='';
        document.getElementById('numPad').innerHTML='';
        if(compoState.idx>=compoState.lines.length){
          if(modeSerie){
            if(!compoState.hadMistake) serieScore++;
            currentAnswered=true; setRefreshLabel(); updateHUD();
          }else{
            document.getElementById('compExplain2').textContent="Exercice termin√©.";
          }
        }
        renderComposedLines();
      }else{
        ln.firstTryOk = false; compoState.hadMistake=true;
        div.classList.add('error');
        exp.textContent = `Attendu : ${ln.expectedRHS}`;
        ln.copyMode = true;
        buildOpBar(input);
        buildNumPad(input);
      }
    };

    div.appendChild(label);
    div.appendChild(input);
    div.appendChild(btn);
    div.appendChild(clr);
    div.appendChild(exp);
    wrap.appendChild(div);
  });
}

/* ============== Bouton ‚ÄúNouvel exercice / Suivant‚Äù ============== */
function handleRefresh(){
  if(modeSerie){
    if(!currentAnswered) return;
    if(serieIndex < serieTotal){
      serieIndex++;
      generateForCurrent();
      updateHUD();
    }else{
      finishSerie();
    }
  }else{
    generateForCurrent();
  }
}
function finishSerie(){
  modeSerie=false; lockUI(false); updateHUD(); setRefreshLabel();
  const msg=`‚úÖ S√©rie termin√©e : ${serieScore}/${serieTotal} (${Math.round(100*serieScore/serieTotal)}%)`;
  document.getElementById(getExplainId()).textContent=msg;
}

/* ============== Moteur / Nav ============== */
function generateForCurrent(){
  if(current==='comparaison') newComparison();
  else if(current==='valabs') newValAbs();
  else if(current==='addition') newAddition();
  else if(current==='soustraction') newSubtraction();
  else if(current==='multiplication') newMultiplication();
  else if(current==='division') newDivision();
  else if(current==='composes') generateComposed();
  setRefreshLabel(); updateHUD();
}
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  current=id;
  generateForCurrent();
}

/* ============== Calculatrice (boutons color√©s) ============== */
(function makeCalc(){
  const keys=["7","8","9","/","4","5","6","*","1","2","3","-","0",".","=","+","(",")","C"];
  const box=document.getElementById('calcButtons');
  keys.forEach(k=>{
    const b=document.createElement('button'); 
    b.textContent=k;
    if(k==="=") b.classList.add('eqBtn');
    if(k==="C") b.classList.add('clrBtn');
    b.onclick=()=>{
      const d=document.getElementById('calcDisplay');
      if(k==="C") d.value="";
      else if(k==="="){ try{ d.value=eval(d.value); }catch{ d.value="Erreur"; } }
      else d.value+=k;
    };
    box.appendChild(b);
  });
})();

/* ============== D√©marrage ============== */
window.onload=()=>{ 
  applyCalcPlacement();
  document.getElementById('level').value=String(globalLevel);
  showSection('comparaison'); 
};
</script>
</body>
</html>
